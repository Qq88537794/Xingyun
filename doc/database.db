SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 1. 用户表
CREATE TABLE IF NOT EXISTS `users` (
                                       `id` BIGINT NOT NULL AUTO_INCREMENT,
                                       `username` VARCHAR(64) NOT NULL,
                                       `email` VARCHAR(255) NOT NULL,
                                       `password_hash` VARCHAR(255) NOT NULL,
                                       `avatar` VARCHAR(512) DEFAULT NULL,
                                       `settings` JSON DEFAULT NULL,
                                       `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                       PRIMARY KEY (`id`),
                                       UNIQUE KEY `uk_username` (`username`),
                                       UNIQUE KEY `uk_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. 项目表
CREATE TABLE IF NOT EXISTS `projects` (
                                          `id` BIGINT NOT NULL AUTO_INCREMENT,
                                          `user_id` BIGINT NOT NULL,
                                          `name` VARCHAR(128) NOT NULL,
                                          `description` TEXT,
                                          `status` VARCHAR(32) DEFAULT 'active',
                                          `is_deleted` TINYINT(1) DEFAULT 0,
                                          `deleted_at` TIMESTAMP NULL DEFAULT NULL,
                                          `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                          PRIMARY KEY (`id`),
                                          KEY `idx_user_id` (`user_id`),
                                          CONSTRAINT `fk_projects_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3. 项目资源表
CREATE TABLE IF NOT EXISTS `project_resources` (
                                                   `id` BIGINT NOT NULL AUTO_INCREMENT,
                                                   `project_id` BIGINT NOT NULL,
                                                   `filename` VARCHAR(255) NOT NULL,
                                                   `file_path` VARCHAR(512) NOT NULL,
                                                   `storage_provider` VARCHAR(32) DEFAULT 'local',
                                                   `mime_type` VARCHAR(128) DEFAULT NULL,
                                                   `file_size` BIGINT DEFAULT 0,
                                                   `parsing_status` VARCHAR(32) DEFAULT 'pending',
                                                   `vector_collection_id` VARCHAR(128) DEFAULT NULL,
                                                   `error_msg` TEXT,
                                                   `uploaded_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                                   PRIMARY KEY (`id`),
                                                   KEY `idx_project_id` (`project_id`),
                                                   CONSTRAINT `fk_resources_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 4. 文档表
CREATE TABLE IF NOT EXISTS `documents` (
                                           `id` BIGINT NOT NULL AUTO_INCREMENT,
                                           `project_id` BIGINT NOT NULL,
                                           `title` VARCHAR(255) DEFAULT 'Untitled',
                                           `content_json` JSON NOT NULL,
                                           `current_version` INT DEFAULT 1,
                                           `lock_version` INT DEFAULT 0 COMMENT '乐观锁版本',
                                           `last_modified_by` VARCHAR(32) DEFAULT 'user',
                                           `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                                           PRIMARY KEY (`id`),
                                           KEY `idx_project_id` (`project_id`),
                                           CONSTRAINT `fk_documents_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 5. 快照表
CREATE TABLE IF NOT EXISTS `document_snapshots` (
                                                    `id` BIGINT NOT NULL AUTO_INCREMENT,
                                                    `document_id` BIGINT NOT NULL,
                                                    `version_num` INT NOT NULL,
                                                    `content_json` JSON NOT NULL,
                                                    `change_reason` VARCHAR(255) DEFAULT NULL,
                                                    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                                    PRIMARY KEY (`id`),
                                                    KEY `idx_document_id` (`document_id`),
                                                    CONSTRAINT `fk_snapshots_document` FOREIGN KEY (`document_id`) REFERENCES `documents` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 6. 会话表
CREATE TABLE IF NOT EXISTS `chat_sessions` (
                                               `id` BIGINT NOT NULL AUTO_INCREMENT,
                                               `project_id` BIGINT NOT NULL,
                                               `title` VARCHAR(128) DEFAULT 'New Chat',
                                               `mode` VARCHAR(32) DEFAULT 'chat',
                                               `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                               PRIMARY KEY (`id`),
                                               KEY `idx_project_id` (`project_id`),
                                               CONSTRAINT `fk_sessions_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 7. 消息表
CREATE TABLE IF NOT EXISTS `chat_messages` (
                                               `id` BIGINT NOT NULL AUTO_INCREMENT,
                                               `session_id` BIGINT NOT NULL,
                                               `role` VARCHAR(32) NOT NULL,
                                               `content` LONGTEXT NOT NULL,
                                               `token_count` INT DEFAULT 0,
                                               `vector_id` VARCHAR(128) DEFAULT NULL,
                                               `thought_chain` LONGTEXT,
                                               `user_feedback` TINYINT DEFAULT NULL COMMENT '1=like, -1=dislike',
                                               `ref_resource_ids` JSON DEFAULT NULL,
                                               `tool_calls` JSON DEFAULT NULL,
                                               `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                               PRIMARY KEY (`id`),
                                               KEY `idx_session_id` (`session_id`),
                                               CONSTRAINT `fk_messages_session` FOREIGN KEY (`session_id`) REFERENCES `chat_sessions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 8. 摘要表
CREATE TABLE IF NOT EXISTS `chat_summaries` (
                                                `id` BIGINT NOT NULL AUTO_INCREMENT,
                                                `session_id` BIGINT NOT NULL,
                                                `summary_text` TEXT NOT NULL,
                                                `vector_id` VARCHAR(128) DEFAULT NULL,
                                                `start_msg_id` BIGINT NOT NULL,
                                                `end_msg_id` BIGINT NOT NULL,
                                                `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                                PRIMARY KEY (`id`),
                                                KEY `idx_summary_session` (`session_id`),
                                                CONSTRAINT `fk_summaries_session` FOREIGN KEY (`session_id`) REFERENCES `chat_sessions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 9. 后台任务表 (NEW)
CREATE TABLE IF NOT EXISTS `background_tasks` (
                                                  `id` BIGINT NOT NULL AUTO_INCREMENT,
                                                  `project_id` BIGINT NOT NULL,
                                                  `task_type` VARCHAR(32) NOT NULL COMMENT 'rag_indexing, doc_gen, export',
                                                  `status` VARCHAR(32) DEFAULT 'pending',
                                                  `progress` INT DEFAULT 0,
                                                  `result_data` JSON DEFAULT NULL,
                                                  `error_log` TEXT DEFAULT NULL,
                                                  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                                  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                                                  PRIMARY KEY (`id`),
                                                  KEY `idx_task_project` (`project_id`),
                                                  CONSTRAINT `fk_tasks_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

SET FOREIGN_KEY_CHECKS = 1;