# 行云 (Xingyun) - 智能文档自动化工作站

## 数据库设计规范 v2.4 (MySQL 版 - 生产级优化)

### 1. 设计概述

本设计基于 MySQL 8.0+，服务于 Electron + FastAPI 架构。

v2.4 变更重点：

新增 **文件夹管理** 功能，支持项目的层级分类组织。文件夹表支持无限层级嵌套、自定义颜色和图标、排序功能以及软删除机制。

v2.3 变更重点：

结合生产环境落地需求，新增 异步任务队列、乐观锁并发控制 及 用户反馈 机制，提升系统的健壮性与可维护性。

### 2. 实体关系图 (ER Diagram)

```
erDiagram
    USERS ||--o{ PROJECTS : "创建"
    USERS ||--o{ FOLDERS : "拥有"
    FOLDERS ||--o{ PROJECTS : "包含"
    FOLDERS ||--o{ FOLDERS : "子文件夹"
    PROJECTS ||--o{ PROJECT_RESOURCES : "包含素材"
    PROJECTS ||--o{ DOCUMENTS : "包含文档"
    PROJECTS ||--o{ CHAT_SESSIONS : "进行对话"
    PROJECTS ||--o{ BACKGROUND_TASKS : "后台任务"
  
    CHAT_SESSIONS ||--o{ CHAT_MESSAGES : "短期记忆"
    CHAT_SESSIONS ||--o{ CHAT_SUMMARIES : "长期记忆"
  
    FOLDERS {
        bigint parent_id "父文件夹ID"
        string color "文件夹颜色"
        string icon "文件夹图标"
        int sort_order "排序顺序"
    }
  
    DOCUMENTS {
        int lock_version "乐观锁"
    }

    BACKGROUND_TASKS {
        string task_type "rag_index/generate/export"
        int progress "0-100"
        string status "pending/processing/done"
    }

```

### 3. 数据表详细定义

#### 3.1 基础域 (Foundation Domain)

**3.1.1 用户表 (`users`)**

| **字段名**  | **类型** | **必填** | **默认值** | **说明**    |
| ----------------- | -------------- | -------------- | ---------------- | ----------------- |
| `id`            | BIGINT         | YES            | -                | 主键，自增        |
| `username`      | VARCHAR(64)    | YES            | -                | 用户名 (Unique)   |
| `email`         | VARCHAR(255)   | YES            | -                | 邮箱地址 (Unique) |
| `password_hash` | VARCHAR(255)   | YES            | -                | 密码哈希          |
| `avatar`        | VARCHAR(512)   | NO             | NULL             | 用户头像路径      |
| `description`   | TEXT           | NO             | NULL             | 用户个人简介      |
| `settings`      | JSON           | NO             | NULL             | 用户偏好设置      |
| `last_login`    | TIMESTAMP      | NO             | NULL             | 最后登录时间      |

**3.1.2 文件夹表 (`folders`)** - **v2.4 新增**

*用于项目的层级分类组织，支持无限层级嵌套、自定义外观和排序。*

| **字段名**   | **类型**    | **必填** | **默认值**        | **说明**                                |
| ------------ | ----------- | -------- | ----------------- | --------------------------------------- |
| `id`         | BIGINT      | YES      | -                 | 主键，自增                              |
| `user_id`    | BIGINT      | YES      | -                 | 外键 -> users.id                        |
| `name`       | VARCHAR(128)| YES      | -                 | 文件夹名称                              |
| `color`      | VARCHAR(32) | NO       | 'blue'            | 文件夹颜色 (用于 UI 展示)               |
| `icon`       | VARCHAR(32) | NO       | 'folder'          | 文件夹图标名称                          |
| `parent_id`  | BIGINT      | NO       | NULL              | 父文件夹 ID (NULL 表示根级文件夹)       |
| `sort_order` | INT         | NO       | 0                 | 排序顺序 (数值越小越靠前)               |
| `is_deleted` | TINYINT(1)  | NO       | 0                 | 软删除标记 (1=已删)                     |
| `deleted_at` | TIMESTAMP   | NO       | NULL              | 删除时间                                |
| `created_at` | TIMESTAMP   | NO       | CURRENT_TIMESTAMP | 创建时间                                |

**索引设计：**
- `idx_user_id` - 按用户快速查找文件夹
- `idx_parent_id` - 按父文件夹快速查找子文件夹

**外键约束：**
- `fk_folders_user` -> `users.id` (ON DELETE CASCADE)
- `fk_folders_parent` -> `folders.id` (ON DELETE CASCADE)

---

**3.1.3 项目表 (`projects`)**

| **字段名**   | **类型**    | **必填** | **默认值**        | **说明**                                |
| ------------ | ----------- | -------- | ----------------- | --------------------------------------- |
| `id`         | BIGINT      | YES      | -                 | 主键，自增                              |
| `user_id`    | BIGINT      | YES      | -                 | 外键 -> users.id                        |
| `folder_id`  | BIGINT      | NO       | NULL              | **v2.4 新增**: 外键 -> folders.id       |
| `name`       | VARCHAR(128)| YES      | -                 | 项目名称                                |
| `description`| TEXT        | NO       | NULL              | 项目背景描述                            |
| `status`     | VARCHAR(32) | YES      | 'active'          | active / archived                       |
| `is_deleted` | TINYINT(1)  | YES      | 0                 | 软删除标记 (1=已删)                     |
| `deleted_at` | TIMESTAMP   | NO       | NULL              | 删除时间                                |
| `created_at` | TIMESTAMP   | YES      | CURRENT_TIMESTAMP | 创建时间                                |

**v2.4 变更：** 新增 `folder_id` 字段，允许项目归属于某个文件夹。外键约束设置为 `ON DELETE SET NULL`，即文件夹删除时项目不会被删除，只是取消文件夹关联。

#### 3.2 资源与 RAG 域 (Resource & RAG Domain)

**3.2.1 项目资源表 (`project_resources`)**

| **字段名**         | **类型** | **必填** | **默认值**  | **说明**                                    |
| ------------------------ | -------------- | -------------- | ----------------- | ------------------------------------------------- |
| `id`                   | BIGINT         | YES            | -                 | 主键                                              |
| `project_id`           | BIGINT         | YES            | -                 | 外键 -> projects.id                               |
| `filename`             | VARCHAR(255)   | YES            | -                 | 原始文件名                                        |
| `file_path`            | VARCHAR(512)   | YES            | -                 | 存储路径                                          |
| `storage_provider`     | VARCHAR(32)    | YES            | 'local'           | **新增** : 'local', 's3', 'oss'             |
| `mime_type`            | VARCHAR(128)   | YES            | -                 | **新增** : 标准 MIME 类型 (application/pdf) |
| `file_size`            | BIGINT         | YES            | 0                 | 字节数                                            |
| `parsing_status`       | VARCHAR(32)    | YES            | 'pending'         | pending / parsing / indexed / error               |
| `vector_collection_id` | VARCHAR(128)   | NO             | NULL              | ChromaDB Collection ID                            |
| `error_msg`            | TEXT           | NO             | NULL              | 错误日志                                          |
| `uploaded_at`          | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 上传时间                                          |
| `is_deleted`           | TINYINT(1)     | YES            | 0                 | **新增** : 软删除标记 (1=已删)             |
| `deleted_at`           | TIMESTAMP      | NO             | NULL              | **新增** : 删除时间                            |

#### 3.3 核心创作域 (Creation Domain)

**3.3.1 文档模型表 (`documents`)**

| **字段名**     | **类型** | **必填** | **默认值**  | **说明**                                      |
| -------------------- | -------------- | -------------- | ----------------- | --------------------------------------------------- |
| `id`               | BIGINT         | YES            | -                 | 主键                                                |
| `project_id`       | BIGINT         | YES            | -                 | 外键 -> projects.id                                 |
| `title`            | VARCHAR(255)   | YES            | 'Untitled'        | 文档标题                                            |
| `content_json`     | JSON           | YES            | -                 | TipTap JSON 数据结构                                |
| `current_version`  | INT            | YES            | 1                 | 当前版本号                                          |
| `lock_version`     | INT            | YES            | 0                 | **新增** : 乐观锁版本号，防止 AI 与人并发冲突 |
| `last_modified_by` | VARCHAR(32)    | YES            | 'user'            | 'user' / 'ai_agent'                                 |
| `updated_at`       | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 最后更新时间                                        |

**3.3.2 文档快照表 (`document_snapshots`)**

| **字段名**  | **类型** | **必填** | **默认值**  | **说明**       |
| ----------------- | -------------- | -------------- | ----------------- | -------------------- |
| `id`            | BIGINT         | YES            | -                 | 主键                 |
| `document_id`   | BIGINT         | YES            | -                 | 外键 -> documents.id |
| `version_num`   | INT            | YES            | -                 | 版本号               |
| `content_json`  | JSON           | YES            | -                 | 完整 JSON 数据       |
| `change_reason` | VARCHAR(255)   | NO             | NULL              | 变更原因             |
| `created_at`    | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 快照时间             |

#### 3.4 AI 记忆与交互域 (AI Memory & Interaction Domain)

**3.4.1 会话表 (`chat_sessions`)**

| **字段名** | **类型** | **必填** | **默认值**  | **说明**        |
| ---------------- | -------------- | -------------- | ----------------- | --------------------- |
| `id`           | BIGINT         | YES            | -                 | 主键                  |
| `project_id`   | BIGINT         | YES            | -                 | 外键 -> projects.id   |
| `title`        | VARCHAR(128)   | NO             | 'New Chat'        | 会话标题              |
| `mode`         | VARCHAR(32)    | YES            | 'chat'            | 'chat' / 'agent_plan' |
| `created_at`   | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 开始时间              |

**3.4.2 消息表 (`chat_messages`)**

| **字段名**     | **类型** | **必填** | **默认值**  | **说明**                                      |
| -------------------- | -------------- | -------------- | ----------------- | --------------------------------------------------- |
| `id`               | BIGINT         | YES            | -                 | 主键                                                |
| `session_id`       | BIGINT         | YES            | -                 | 外键 -> chat_sessions.id                            |
| `role`             | VARCHAR(32)    | YES            | -                 | 'user', 'assistant', 'system'                       |
| `content`          | LONGTEXT       | YES            | -                 | 消息正文                                            |
| `token_count`      | INT            | YES            | 0                 | 估算Token数                                         |
| `vector_id`        | VARCHAR(128)   | NO             | NULL              | 关联向量库ID                                        |
| `thought_chain`    | LONGTEXT       | NO             | NULL              | AI 思维链                                           |
| `user_feedback`    | TINYINT        | NO             | NULL              | **新增** : 1=Like, -1=Dislike, NULL=No action |
| `ref_resource_ids` | JSON           | NO             | NULL              | 引用资料ID                                          |
| `tool_calls`       | JSON           | NO             | NULL              | 工具调用记录                                        |
| `created_at`       | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 发送时间                                            |

**3.4.3 对话摘要表 (`chat_summaries`)**

| **字段名** | **类型** | **必填** | **默认值**  | **说明**           |
| ---------------- | -------------- | -------------- | ----------------- | ------------------------ |
| `id`           | BIGINT         | YES            | -                 | 主键                     |
| `session_id`   | BIGINT         | YES            | -                 | 外键 -> chat_sessions.id |
| `summary_text` | TEXT           | YES            | -                 | 摘要内容                 |
| `vector_id`    | VARCHAR(128)   | NO             | NULL              | 摘要的向量ID             |
| `start_msg_id` | BIGINT         | YES            | -                 | 覆盖的消息起始ID         |
| `end_msg_id`   | BIGINT         | YES            | -                 | 覆盖的消息结束ID         |
| `created_at`   | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 创建时间                 |

#### 3.5 系统任务域 (System Task Domain) - NEW

**3.5.1 后台任务表 (`background_tasks`)** *用于追踪耗时操作（RAG 索引、长文档生成、导出），支持前端进度条轮询和断点恢复。*

| **字段名** | **类型** | **必填** | **默认值**  | **说明**                          |
| ---------------- | -------------- | -------------- | ----------------- | --------------------------------------- |
| `id`           | BIGINT         | YES            | -                 | 主键                                    |
| `project_id`   | BIGINT         | YES            | -                 | 外键 -> projects.id                     |
| `task_type`    | VARCHAR(32)    | YES            | -                 | 'rag_indexing', 'doc_gen', 'export_pdf' |
| `status`       | VARCHAR(32)    | YES            | 'pending'         | pending/processing/completed/failed     |
| `progress`     | INT            | YES            | 0                 | 进度百分比 (0-100)                      |
| `result_data`  | JSON           | NO             | NULL              | 任务结果(如导出文件的下载链接)          |
| `error_log`    | TEXT           | NO             | NULL              | 错误详情                                |
| `created_at`   | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 创建时间                                |
| `updated_at`   | TIMESTAMP      | YES            | CURRENT_TIMESTAMP | 更新时间                                |

### 4. 初始化 SQL 脚本 (MySQL 8.0+)

```
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 1. 用户表
CREATE TABLE IF NOT EXISTS `users` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `username` VARCHAR(64) NOT NULL,
  `email` VARCHAR(255) NOT NULL,
  `password_hash` VARCHAR(255) NOT NULL,
  `avatar` VARCHAR(512) DEFAULT NULL,
  `description` TEXT DEFAULT NULL,
  `settings` JSON DEFAULT NULL,
  `last_login` TIMESTAMP NULL DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. 文件夹表 (v2.4 新增)
CREATE TABLE IF NOT EXISTS `folders` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL,
  `name` VARCHAR(128) NOT NULL,
  `color` VARCHAR(32) DEFAULT 'blue',
  `icon` VARCHAR(32) DEFAULT 'folder',
  `parent_id` BIGINT DEFAULT NULL,
  `sort_order` INT DEFAULT 0,
  `is_deleted` TINYINT(1) DEFAULT 0,
  `deleted_at` TIMESTAMP NULL DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_parent_id` (`parent_id`),
  CONSTRAINT `fk_folders_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_folders_parent` FOREIGN KEY (`parent_id`) REFERENCES `folders` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3. 项目表
CREATE TABLE IF NOT EXISTS `projects` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL,
  `folder_id` BIGINT DEFAULT NULL,
  `name` VARCHAR(128) NOT NULL,
  `description` TEXT,
  `status` VARCHAR(32) DEFAULT 'active',
  `is_deleted` TINYINT(1) DEFAULT 0,
  `deleted_at` TIMESTAMP NULL DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_folder_id` (`folder_id`),
  CONSTRAINT `fk_projects_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_projects_folder` FOREIGN KEY (`folder_id`) REFERENCES `folders` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 4. 项目资源表
CREATE TABLE IF NOT EXISTS `project_resources` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `project_id` BIGINT NOT NULL,
  `filename` VARCHAR(255) NOT NULL,
  `file_path` VARCHAR(512) NOT NULL,
  `storage_provider` VARCHAR(32) DEFAULT 'local',
  `mime_type` VARCHAR(128) DEFAULT NULL,
  `file_size` BIGINT DEFAULT 0,
  `parsing_status` VARCHAR(32) DEFAULT 'pending',
  `vector_collection_id` VARCHAR(128) DEFAULT NULL,
  `error_msg` TEXT,
  `uploaded_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `is_deleted` TINYINT(1) DEFAULT 0,
  `deleted_at` TIMESTAMP NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_project_id` (`project_id`),
  CONSTRAINT `fk_resources_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 5. 文档表
CREATE TABLE IF NOT EXISTS `documents` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `project_id` BIGINT NOT NULL,
  `title` VARCHAR(255) DEFAULT 'Untitled',
  `content_json` JSON NOT NULL,
  `current_version` INT DEFAULT 1,
  `lock_version` INT DEFAULT 0 COMMENT '乐观锁版本',
  `last_modified_by` VARCHAR(32) DEFAULT 'user',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_project_id` (`project_id`),
  CONSTRAINT `fk_documents_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 6. 快照表
CREATE TABLE IF NOT EXISTS `document_snapshots` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `document_id` BIGINT NOT NULL,
  `version_num` INT NOT NULL,
  `content_json` JSON NOT NULL,
  `change_reason` VARCHAR(255) DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_document_id` (`document_id`),
  CONSTRAINT `fk_snapshots_document` FOREIGN KEY (`document_id`) REFERENCES `documents` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 7. 会话表
CREATE TABLE IF NOT EXISTS `chat_sessions` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `project_id` BIGINT NOT NULL,
  `title` VARCHAR(128) DEFAULT 'New Chat',
  `mode` VARCHAR(32) DEFAULT 'chat',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_project_id` (`project_id`),
  CONSTRAINT `fk_sessions_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 8. 消息表
CREATE TABLE IF NOT EXISTS `chat_messages` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `session_id` BIGINT NOT NULL,
  `role` VARCHAR(32) NOT NULL,
  `content` LONGTEXT NOT NULL,
  `token_count` INT DEFAULT 0,
  `vector_id` VARCHAR(128) DEFAULT NULL,
  `thought_chain` LONGTEXT,
  `user_feedback` TINYINT DEFAULT NULL COMMENT '1=like, -1=dislike',
  `ref_resource_ids` JSON DEFAULT NULL,
  `tool_calls` JSON DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_session_id` (`session_id`),
  CONSTRAINT `fk_messages_session` FOREIGN KEY (`session_id`) REFERENCES `chat_sessions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 9. 摘要表
CREATE TABLE IF NOT EXISTS `chat_summaries` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `session_id` BIGINT NOT NULL,
  `summary_text` TEXT NOT NULL,
  `vector_id` VARCHAR(128) DEFAULT NULL,
  `start_msg_id` BIGINT NOT NULL,
  `end_msg_id` BIGINT NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_summary_session` (`session_id`),
  CONSTRAINT `fk_summaries_session` FOREIGN KEY (`session_id`) REFERENCES `chat_sessions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 10. 后台任务表
CREATE TABLE IF NOT EXISTS `background_tasks` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `project_id` BIGINT NOT NULL,
  `task_type` VARCHAR(32) NOT NULL COMMENT 'rag_indexing, doc_gen, export',
  `status` VARCHAR(32) DEFAULT 'pending',
  `progress` INT DEFAULT 0,
  `result_data` JSON DEFAULT NULL,
  `error_log` TEXT DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_task_project` (`project_id`),
  CONSTRAINT `fk_tasks_project` FOREIGN KEY (`project_id`) REFERENCES `projects` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 迁移脚本：为现有 projects 表添加 folder_id 字段 (仅用于已存在数据库的升级)
-- ALTER TABLE `projects` ADD COLUMN `folder_id` BIGINT DEFAULT NULL AFTER `user_id`;
-- ALTER TABLE `projects` ADD KEY `idx_folder_id` (`folder_id`);
-- ALTER TABLE `projects` ADD CONSTRAINT `fk_projects_folder` FOREIGN KEY (`folder_id`) REFERENCES `folders` (`id`) ON DELETE SET NULL;

SET FOREIGN_KEY_CHECKS = 1;

```
